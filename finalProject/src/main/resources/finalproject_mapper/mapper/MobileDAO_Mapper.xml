<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <mapper namespace="kos.triple.project.mobile.MobileDAO">
 	
 	<select id="loginConfirm_proc" parameterType="java.util.Map" resultType="int">
 		SELECT COUNT(*)
 		FROM member
 		WHERE mem_id=#{mem_id} AND password=#{password}
 	</select>
 
 	<select id="startRedirect_proc_beforeTask" parameterType="String" resultType="int">
 		SELECT COUNT(*) 
 		FROM mobileinfo
 		WHERE phonenumber=#{phone}
 	</select>
 
 	<select id="startRedirect_proc" parameterType="String" resultType="int">
 		SELECT NVL(islogin,0)
 		FROM mobileinfo
 		WHERE phonenumber=#{phone}
 	</select>
 	
 
 	<delete id="phoneSync_proc_step1" parameterType="String">
 		DELETE FROM MOBILEINFO 
		WHERE mem_id=#{mem_id}
 	</delete>
 	
 	<insert id="phoneSync_proc_step2" parameterType="java.util.Map">	 		
		INSERT INTO MOBILEINFO VALUES(
		  MOBILEINFO_SEQ.NEXTVAL , #{mem_id} , #{phonenumber} , #{islogin}
		)
	</insert>
 	
 	<select id="getSavedId_proc" parameterType="String" resultType="String">
 		SELECT mem_id 
		FROM mobileinfo
		WHERE phonenumber=#{phonenumber}
 	</select>
 	
 	<delete id="mobileLogout_proc" parameterType="java.util.Map">
 		DELETE FROM mobileinfo
 		WHERE phonenumber=#{phonenumber} AND mem_id=#{mem_id}
 	</delete>
 	
 	<select id="getAirportNo_proc" parameterType="String" resultType="String">
 		SELECT airportNo
 		FROM airport
 		WHERE airportName=#{location}
 	</select>
 	
 
 	<select id="airPlaneSearch_proc" parameterType="java.util.Map" resultType="kos.triple.project.mobile.vo.AirReservationSearchVO">
			SELECT * 
			FROM route 
			NATURAL JOIN airplane
			NATURAL JOIN seatPrice
		<where>
			 premium+highclass+nomal>0
			<if test="startAirport_Key != null">
				AND	route1=#{startAirport_Key} 
			</if>
			<if test="endAirport_Key != null">
				AND ( route2=#{endAirport_Key} OR route3=#{endAirport_Key} )
			</if>
			<if test="s_fromDate != null">
				AND starttime &gt;= #{s_fromDate}
			</if>
			<if test="s_toDate != null">
				AND arrivaltime &lt; TO_DATE( #{s_toDate} )+1
			</if>
		</where>
		ORDER BY startTime
	</select>
 	
 	<select id="getAirportName_proc" parameterType="String" resultType="String">
 		SELECT airportname
 		FROM airport
 		WHERE airportNo=#{routeNo}
 	</select>
 	

 	
 	<select id="getReserVationInfo_proc" parameterType="String" resultType="kos.triple.project.mobile.vo.AirReservationSearchVO">
 		SELECT *
		FROM AIRPLANE
		NATURAL JOIN ROUTE
		NATURAL JOIN SEATPRICE
		WHERE airPlaneNo = #{airPlaneNo}
 	</select>
 	
 	<select id="getRouteInfo" parameterType="String" resultType="kos.triple.project.vo.RouteVO">
 		SELECT * 
		FROM ROUTE
		WHERE routeno = (SELECT routeno 
						 FROM airplane 
						 WHERE airplaneno=#{airPlaneNo})
 	</select>
 
 	<insert id="reservationComplete_proc" parameterType="kos.triple.project.vo.AirReservationDetailVO">
		INSERT INTO RES_AIR
		VALUES(
			RES_AIR_SEQ.NEXTVAL,#{mem_id},#{memSize},#{payMethod},
			#{price},#{airPlaneNo},SYSTIMESTAMP,#{adult},#{baby},#{student},
			#{seatLevel_adult},#{seatLevel_baby},#{seatLevel_student},
			#{startLocation},#{endLocation},#{startTime},#{endTime}
		)
	</insert>
	
	<update id="setRemainSeatUpdate" parameterType="java.util.Map">
		<if test="seatLevel.equals('nomal')">
			UPDATE airplane
			SET nomal = nomal - #{memSize}
			WHERE airPlaneNo = #{airPlaneNo}
		</if>
		<if test="seatLevel.equals('highClass')">
			UPDATE airplane
			SET highClass = highClass - #{memSize}
			WHERE airPlaneNo = #{airPlaneNo}
		</if>
		<if test="seatLevel.equals('premium')">
			UPDATE airplane
			SET premium = premium - #{memSize}
			WHERE airPlaneNo = #{airPlaneNo}
		</if>
	</update>
	
 </mapper>